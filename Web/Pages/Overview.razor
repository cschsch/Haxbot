@page "/overview"

<PageTitle>Overview</PageTitle>

@using Haxbot.Entities
@using Haxbot.Stats
@using Web.Data
@inject GamesService GamesService
@inject INotificationService NotificationService

<Heading Size="HeadingSize.Is1">Overview</Heading>

<Paragraph>Use this to filter previously played games and to display various stats taken from them in graphs.</Paragraph>

<Row Gutter="(32, 16)">
    <Column Margin="Margin.Is1" Border="Border.Is1.Rounded">
        <PlayerFilter QueryModel="QueryModel" />
    </Column>
    <Column Margin="Margin.Is1" Border="Border.Is1.Rounded">
        <TimeFilter QueryModel="QueryModel" />
    </Column>
</Row>
<Row Gutter="(32, 16)" Margin="Margin.Is1.FromTop">
    <Column ColumnSize="ColumnSize.Is5" Margin="Margin.Is1" Border="Border.Is1.Rounded">
        <MiscFilter QueryModel="QueryModel" />
    </Column>
    <Column ColumnSize="ColumnSize.Is5" Margin="Margin.Is1" Border="Border.Is1.Rounded">
        <Heading Size="HeadingSize.Is6">Options for data aggregation</Heading>
        <Divider />
        <Check @bind-Checked="_groupByTeam">Group by teams instead of players</Check>
    </Column>
    <Column Margin="Margin.Is1">
        <Button Size="Size.Large" Position="Position.Absolute.Bottom.Is0.End.Is0" Clicked="@(() => NotificationService?.Info("Searching for games...", "Searching...")!.ContinueWith(_ => GetGames())!)" Color="Color.Primary">Aggregate</Button>
    </Column>
</Row>

<Divider />

<Tabs RenderMode="TabsRenderMode.LazyLoad" SelectedTab="byDay">
    <Items>
        <Tab Name="byDay">By Day</Tab>
    </Items>
    <Content>
        <TabPanel Name="byDay">
            <Tabs SelectedTab="winrate" Margin="Margin.Is1.FromTop">
                <Items>
                    <Tab Name="winrate">Winrate</Tab>
                    <Tab Name="amountPlayed">Amount played</Tab>
                    <Tab Name="amountWon">Amount won</Tab>
                    <Tab Name="amountLost">Amount lost</Tab>
                </Items>
                <Content>
                    <TabPanel Name="winrate">
                        <LineChart @ref="_lineCharts[0]" TItem="FlattenedGameStats" Options="@CreateOptions(nameof(FlattenedGameStats.Winrate), "Winrate (in %)")" />
                    </TabPanel>
                    <TabPanel Name="amountPlayed">
                        <LineChart @ref="_lineCharts[1]" TItem="FlattenedGameStats" Options="@CreateOptions(nameof(FlattenedGameStats.AmountPlayed), "Amount played")" />
                    </TabPanel>
                    <TabPanel Name="amountWon">
                        <LineChart @ref="_lineCharts[2]" TItem="FlattenedGameStats" Options="@CreateOptions(nameof(FlattenedGameStats.AmountWon), "Amount won")" />
                    </TabPanel>
                    <TabPanel Name="amountLost">
                        <LineChart @ref="_lineCharts[3]" TItem="FlattenedGameStats" Options="@CreateOptions(nameof(FlattenedGameStats.AmountLost), "Amount lost")" />
                    </TabPanel>
                </Content>
            </Tabs>
        </TabPanel>
    </Content>
</Tabs>

@code {
    private GamesQueryModel QueryModel { get; } = new();
    private FlattenedGameStats[] _stats = Array.Empty<FlattenedGameStats>();
    private bool _groupByTeam;

    private List<LineChart<FlattenedGameStats>> _lineCharts = new List<LineChart<FlattenedGameStats>>
    {
        new LineChart<FlattenedGameStats>(),
        new LineChart<FlattenedGameStats>(),
        new LineChart<FlattenedGameStats>(),
        new LineChart<FlattenedGameStats>(),
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) await RedrawLineCharts();
    }

    List<string> _lineChartColors = new List<string>
    {
        ChartColor.FromRgba( 0, 0, 128, 1f ), // navy
        ChartColor.FromRgba( 220, 20, 60, 1f ), // crimson
        ChartColor.FromRgba( 128, 128, 0, 1f ), // olive
        ChartColor.FromRgba( 0, 139, 139, 1f ), // darkcyan
        ChartColor.FromRgba( 139, 0, 139, 1f ), // darkmagenta
        ChartColor.FromRgba( 47, 79, 79, 1f ),  // darkslategray
        ChartColor.FromRgba( 255, 105, 180, 1f ), // hotpink
        ChartColor.FromRgba( 127, 255, 212, 1f ), // aquamarine
        ChartColor.FromRgba( 0, 100, 0, 1f ), // darkgreen
        ChartColor.FromRgba( 255, 215, 0, 1f ) // gold
    };

    private LineChartOptions CreateOptions(string yAxisKey, string yAxisName) => new LineChartOptions
        {
            Parsing = new ChartParsing
            {
                XAxisKey = nameof(FlattenedGameStats.Date).ToLower(),
                YAxisKey = yAxisKey.ToCamelCase()
            },
            Scales = new ChartScales
            {
                Y = new ChartAxis
                {
                    Title = new ChartScaleTitle
                    {
                        Display = true,
                        Text = yAxisName
                    }
                }
            }
        };

    private async Task RedrawLineCharts()
    {
        var datasets = _stats
            .GroupBy(stat => stat.Identification)
            .Zip(_lineChartColors.Cycle())
            .Select(groupColors => new LineChartDataset<FlattenedGameStats>
                {
                    Label = groupColors.First.Key,
                    Data = groupColors.First.OrderBy(stat => stat.Date).Scan((acc, cur) => acc.Add(cur)).ToList(),
                    BackgroundColor = groupColors.Second,
                    BorderColor = groupColors.Second,
                    BorderWidth = 2,
                    CubicInterpolationMode = "default",
                    Fill = false
                }).ToArray();

        foreach (var chart in _lineCharts)
        {
            await chart.Clear();
            await chart.AddDatasetsAndUpdate(datasets);
        }
    }

    private async Task GetGames()
    {
        var games = GamesService.GetGames(QueryModel);
        if (!games.Any()) await NotificationService?.Warning("Try changing your search criteria.", "No games found!")!;
        _stats = _groupByTeam
            ? GamesService.CollectStats<TeamStatsCollector>(games).ToArray()
            : GamesService.CollectStats<PlayerStatsCollector>(games).ToArray();
        await RedrawLineCharts();
    }
}